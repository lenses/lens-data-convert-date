<link rel="import" href="../polymer/polymer.html"> 
<link rel="import" href="../iron-input/iron-input.html"> 
<link rel="import" href="../iron-selector/iron-selector.html"> 

<!--
A data component for converting dates with moment.js. For more info on date formats,
click <a href="http://momentjs.com/docs/#/displaying/format/" target="_blank">here</a>.

Example:

    <lens-data-convert-date></lens-data-convert-date>

@demo
-->

<dom-module id="lens-data-convert-date">
    <style>
      :host {
        display: inline-block;
        font-size: 1em;
      }

      .small {
        font-size: 0.75em;
      }

      iron-selector {
        min-height: 10px;
        display: inline-block;
        max-height: 123px;
        overflow-y: scroll; 
      }

      iron-selector .col {
        padding: 1px;
        border: 1px solid #EEE;
      }

      iron-selector .iron-selected {
        background-color: #ccc;
      }

      label {
        display: block;
        margin-top: 5px;
        font-weight: 600;
      }

      /* Input fields for custom date format */
      #dateTypeFrom, #dateTypeTo {
        border: 1px solid #eee; 
        padding: 3px; 
        width: 259px; 
        font-size: 0.8em;
        display: block;
      }
    </style>
    <template>
    <core-style ref="theme"></core-style>

    <div class="lens-container lens-data"></div>
      <!-- Column Selection -->
      <label> Date column:</label>
      <iron-selector selected="{{dateColumn}}" attr-for-selected="label">
        <template is="dom-repeat" items="{{_dataAttributes}}" as="attr">
          <div class="col" label="{{attr}}">{{attr}}</div>
        </template>
      </iron-selector>
      
      <!-- FROM Date Type Selection -->
      <label>Select current format:</label>
      <iron-selector class="selector" selected="{{dateTypeFrom}}" attr-for-selected="label">
        <template is="dom-repeat" items="{{_dateFormats}}" as="format">
          <div class="dateItem" label="{{format.type}}"><span>{{format.type}}</span> <span class="small">(i.e. <span>{{format.example}}</span>)</span></div>
        </template>
      </iron-selector>
      <input id="dateTypeFrom" is="core-input" placeholder="Or enter custom format" type="text" committedvalue="{{dateTypeFrom}}">
      
      <!-- TO Date Type Selection -->
      <label>Select new format:</label>
      <iron-selector class="selector" selected="{{dateTypeTo}}" attr-for-selected="label">
        <template is="dom-repeat" items="{{_dateFormats}}" as="format">
          <div class="dateItem" label="{{format.type}}"><span>{{format.type}}</span> <span class="small">(i.e. <span>{{format.example}}</span>)</span></div>
        </template>
      </iron-selector>
      <input id="dateTypeTo" is="core-input" placeholder="Or enter custom format" type="text" committedvalue="{{dateTypeTo}}">
      
      <p class="small">For more info on date formats, click <a href="http://momentjs.com/docs/#/displaying/format/" target="_blank">here</a> </p>
      
      <template is="dom-if" if="{{errors.length}}">
        <p><strong><span>{{errors.length}}</span> date(s) could not be converted due to invalid format:</strong></p>
        <template is="dom-repeat" items="{{errors}}" as="error">
          <li><span>{{error.date}}</span> (row: <span>{{error.row}}</span>)</li>
        </template>
      </template>

     <!-- end lens-container-->

  </template>
  <script src="../moment/min/moment.min.js"></script>
  <script>
    Polymer({
      is: 'lens-data-convert-date',
      properties: {
        /**
         * Input data, where each item in the array is an object
         * @type Array
         * @default []
         */
        input: {
          type: Array,
          value: [],
          observer: '_inputChanged'
        },
        /**
         * Output data, where each item in the array is an object
         * @type Array
         * @default []
         */
        output: {
          type: Array,
          value: [],
          notify: true,
          readOnly: true,
          observer: '_outputChanged'
        },
        dateColumn: {
          notify: true,
          observer: '_calculateOutput'
        },
        dateTypeFrom: {
          notify: true,
          observer: '_calculateOutput'
        },
        dateTypeTo: {
          notify: true,
          observer: '_calculateOutput'
        },
  
        keepOriginalData: {
          type: Boolean,
          value: true,
          observer: '_calculateOutput'
        },
        _dateFormats: {
          type: Array,
          readOnly: true,
          value: function () {
            return [
              {
                type: 'YYYY MM DD',
                example: '2015 01 31'
              },
              {
                type: 'MMMM DD YYYY',
                example: 'January 31, 2015'
              },
              {
                type: 'MMM DD YYYY',
                example: 'Jan 31, 2015'
              },
              {
                type: 'MM-DD-YYYY',
                example: '01-31-2015'
              },
              {
                type: 'MM-DD-YY',
                example: '01-31-15'
              },
              {
                type: 'MMMM YYYY',
                example: 'January 2015'
              },
              {
                type: 'MMM YYYY',
                example: 'Jan 2015'
              },
              {
                type: 'MM-YYYY',
                example: '01-2015'
              },
              {
                type: 'MM-YY',
                example: '01-15'
              },
              {
                type: 'M-D-YYYY',
                example: '1-31-2015'
              },
              {
                type: 'M-D-YY',
                example: '1-31-15'
              },
              {
                type: 'DD MMMM YYYY',
                example: '31 January 2015'
              },
              {
                type: 'DD-MM-YY',
                example: '31-01-15'
              },
              {
                type: 'D-M-YYYY',
                example: '31-1-2015'
              },
              {
                type: 'D-M-YY',
                example: '31-1-15'
              },
              {
                type: 'MMM-DD',
                example: 'Jan-31'
              },
              {
                type: 'MM-DD',
                example: '01-31'
              },
              {
                type: 'M-D',
                example: '1-31'
              },
              {
                type: 'Q YYYY',
                example: 'Q1 2015'
              }
            ];
          }
        }
      },
      ready: function () {
        this._inputChanged();
      },
      _calculateOutput: function () {
        var self = this, 
            inputLength = self.input.length;
        if (this.dateTypeFrom && this.dateTypeTo && this.dateColumn) {
          self.errors = [];
          console.log(self.input);
          // Remapping triggers the change in an observer
          var output = self.input.map(function (item, index) {
            console.log(item);
            var newColName = self.newColName(self.dateColumn, self.dateTypeTo), 
                newDate = self.convertDate(item[self.dateColumn], self.dateTypeFrom, self.dateTypeTo), 
                row = {}, 
                keys = Object.keys(item);

            keys.forEach(function (key) {
              // if not keeping original data, do not include the original column
              if (!self.keepOriginalData && key === self.dateColumn) {
              } else {
                row[key] = item[key];
              }
            });
            if (newDate) {
              row[newColName] = newDate;
            } else {
              self.errors.push({
                row: index + 1,
                date: item[self.dateColumn]
              });
            }
            return row;
          });
          self._setOutput(output);
        }
      },
      newColName: function (oldColName, newFormat) {
        return oldColName + ' (' + newFormat + ')';
      },
      convertDate: function (date, currentFormat, newFormat) {
        return moment(date, currentFormat).isValid() ? moment(date, currentFormat).format(newFormat) : '';
      },

      // OBSERVERS
      _inputChanged: function () {
        var self = this;
        var firstItem = self.input[0];
        if (!firstItem) {
          return;
        }
        self._dataAttributes = Object.keys(firstItem);
      },
      /**
       * The `lens-output-changed` event is fired whenever changes are observed in `output` 
       * 
       * @event lens-output-changed
       */
      _outputChanged: function(newValue, oldValue){
        console.log(this.output);
        this.fire('lens-output-changed', this.output);
      },
    });
  </script>
</dom-module>